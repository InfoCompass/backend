var Resource		= require('deployd/lib/resource'),
	util			= require('util'),
	fs				= require('fs'),
	ejs				= require('ejs')


function Meta(name, options) {
	Resource.apply(this, arguments);
}

util.inherits(Meta, Resource);
module.exports = Meta;


Meta.basicDashboard = {
	settings: [
		{
			name: 			'linkedCollection',
			type: 			'text',
			description: 	'Metadata for items of this collections.'
		},
		{
			name: 			'defaultLanguageCode',
			type: 			'text',
			description: 	'Default language code if none is provided.'
		}
	]
}

Meta.prototype.handle = function (ctx, next) {

	if(ctx.req && ctx.req.method !== 'GET') return ctx.done("Only GET allowed.");

	var parts 	= ctx.url.split('/').filter(function(p) { return p }),
		id		= parts && parts[0],
		lang	= parts && parts[1] || this.config.defaultLanguageCode || 'en'
		self	= this




	console.log(self.options)

	try {
		if(id && this.config.linkedCollection && ctx.dpd[this.config.linkedCollection]){
			ctx.dpd[this.config.linkedCollection].get(id)
			.then(
				function(data){
					fs.readFile(self.options.configPath+'/template.html', {encoding: 'utf-8'}, function(error, template) {
						if(error){
							ctx.res.statusCode = 500
							console.trace(error)
							return ctx.done('internal server error')
						}

						var html = ejs.render(template, {
										item: data, 
										language: self.config.defaultLanguageCode,
										site: {
											title:'',
											twitter:'',
										}
									});
						ctx.done(null, html);
					})
				},
				function(){
					ctx.res.statusCode = 404
					ctx.done('not found')
				}
			)
		} else {
			console.log('Meta: bad config.')
		}
	} catch (ex) {
		console.log(ex);
	}
}